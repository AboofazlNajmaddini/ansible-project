---
- name: Install Nginx on AlmaLinux with Iranian Mirrors
  hosts: targets
  become: yes

  tasks:
    - name: Remove existing iran-mirrors repo if present
      file:
        path: /etc/yum.repos.d/iran-mirrors.repo
        state: absent

    - name: Install dnf-plugins-core
      dnf:
        name: dnf-plugins-core
        state: present

    - name: yumrepo Fama-server
      yum_repository:
        name: Fama-server
        description: Fama-server AlmaLinux 9 Repository
        baseurl:  https://repo.mirror.famaserver.com/almalinux/9/AppStream/x86_64/os/
        failovermethod: priority
        enabled: 1
        gpgcheck: 1
        gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux
    - name: yumrepo appstream-iran
      yum_repository:
        name: appstream-iran
        description: appstream-iran AlmaLinux 9 Repository
        baseurl:  https://repo-portal.ito.gov.ir/repo/old_package/AlmaLinux/9/AppStream/x86_64/
        failovermethod: priority
        enabled: 1
        gpgcheck: 1
        gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux
    - name: yumrepo host-baran
      yum_repository:
        name: host-baran
        description: host-baran AlmaLinux 9 Repository
        baseurl:  https://mirror.hostbaran.com/almalinux/9/AppStream/x86_64/os/
        failovermethod: priority
        enabled: 1
        gpgcheck: 1
        gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux
    - name: yumrepo pars-host
      yum_repository:
        name: pars-host
        description: pars-host AlmaLinux 9 Repository
        baseurl:  https://almalinux.pars.host/9/AppStream/x86_64/os/
        failovermethod: priority
        enabled: 1
        gpgcheck: 1
        gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux
    - name: yumrepo ito-gov
      yum_repository:
        name: ito-gov
        description: ito-gov AlmaLinux 9 Repository
        baseurl:  https://archive.ito.gov.ir/almalinux/9/AppStream/x86_64/os/
        failovermethod: priority
        enabled: 1
        gpgcheck: 1
        gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux
    - name: yumrepo aminDC
      yum_repository:
        name: aminDC
        description: aminDC AlmaLinux 9 Repository
        baseurl:  https://mirror.aminidc.com/almalinux/9/AppStream/x86_64/os/
        failovermethod: priority
        enabled: 1
        gpgcheck: 1
        gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux
    - name: yumrepo rootlicence
      yum_repository:
        name: rootlicence
        description: rootlicence AlmaLinux 9 Repository
        baseurl:  https://mirror.rootlicense.com/almalinux/9/AppStream/x86_64/os/
        failovermethod: priority
        enabled: 1
        gpgcheck: 1
        gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux
    - name: yumrepo sindad
      yum_repository:
        name: sindad
        description: sindad AlmaLinux 9 Repository
        baseurl:  https://ir.almalinux.sindad.cloud/9/AppStream/x86_64/os/
        failovermethod: priority
        enabled: 1
        gpgcheck: 1
        gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux

    - name: Disable default almalinux repos
      command: dnf config-manager --set-disabled almalinux* || true
      ignore_errors: yes

    - name: dnf clean all
      command: dnf clean all

    - name: makecache with retries
      command: dnf makecache
      retries: 5
      delay: 10
      register: cache_result
      until: cache_result.rc == 0

    - name: Install nginx
      dnf:
        name: nginx
        state: present

    - name: Start and enable nginx
      service:
        name: nginx
        state: started
        enabled: yes